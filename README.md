# Multi-Chain SubSquid API

This is a project generated by `hydra-cli scaffold`. It allows for multiple substrate chains to be indexed and queried
through a GraphQL endpoint. Currently this only supports the Polkadot and Kusama substrate chains. 
This project uses packages derived from a fork of the `subsquid/hydra` which supports a `hydra-processor` which
can pull and process multiple chains. There is a slightly modified `schema.graphql` which supports querying each
 Substrate chain. 

## Prerequisites

* Node v14x
* Docker

## Chain Type Generation

Currently, in order to support multiple chains with the type generation (typegen). You can generate
each chains generated code by commenting/uncommenting the `typegen` portion of the `manifest.yml` file.

Example for polkadot `typegen`

Here is what the `typegen` portion of the `manifest.yml` file will look like to generate the Polkadot `.ts` files
```yaml
typegen:
  metadata:
    source: wss://kusama-rpc.polkadot.io/
    blockHash: '0x45eb7ddd324361adadd4f8cfafadbfb7e0a26393a70a70e5bee6204fc46af62e'
  events:
    - balances.Transfer
  calls:
    - timestamp.set
  outDir: chain/kusama

# typegen:
#   metadata:
#     source: wss://rpc.polkadot.io/
#     blockHash: '0x85b133210631562ef26d3cb1a0781396ab13fa5e2118a74c4f8ed59c6cf8c9ab'
#   events:
#     - balances.Transfer
#   calls:
#     - timestamp.set
#   outDir: chain/polkadot
```

In order to generate the Kusama `.ts` files you can flip the commented section of the `typegen` i.e.:

```yml
# typegen:
#   metadata:
#     source: wss://kusama-rpc.polkadot.io/
#     blockHash: '0x45eb7ddd324361adadd4f8cfafadbfb7e0a26393a70a70e5bee6204fc46af62e'
#   events:
#     - balances.Transfer
#   calls:
#     - timestamp.set
#   outDir: chain/kusama

typegen:
  metadata:
    source: wss://rpc.polkadot.io/
    blockHash: '0x85b133210631562ef26d3cb1a0781396ab13fa5e2118a74c4f8ed59c6cf8c9ab'
  events:
    - balances.Transfer
  calls:
    - timestamp.set
  outDir: chain/polkadot
```

NOTE: There has been some work done to support multiple metadata sources and generate
the type generations given multiple entries/sources [here](https://github.com/cpurta/hydra/tree/support-multiple-metadata-sources/packages/hydra-typegen).
This work is **currently being tested** and has yet to be published on NPM as a package
and imported into this project for ease of generating the multiple chain types. 

## Bootstrap

```bash
# The dependencies setup relies on de-duplication, use `ci` to get everything right
npm ci

# Start a postgres instance
docker-compose up db # add optional -d flag to detach from terminal

# Apply migrations related to the processor's state keeping tables
npm run processor:migrate

# Apply the project's migrations
npm run db:migrate

# Now you can start processing chain data
npm run processor:start

# The above command will block
# Open a separate terminal and launch the graphql server to query the processed data
npm run query-node:start
```

## Project structure

Hydra tools expect a certain directory layout:

* `generated` - model/server definitions created by `codegen`. Do not alter the contents of this directory manually.
* `server-extension` - a place for custom data models and resolvers defined via `*.model.ts` and `*.resolver.ts` files.
* `chain` - data type definitions for chain events and extrinsics created by `typegen`.
* `mappings` - mapping module.
* `.env` - hydra tools are heavily driven by environment variables defined here or supplied by a shell.

## Development flow

If you modified `schema.graphql`:

```bash
# Run codegen to re-generate model/server files
npm run codegen

# Analyze database state and create a new migration to match generated models
npm run db:create-migration # add -n "myName" to skip the migration name prompt

# Apply the migrations
npm run db:migrate
```

You might want update the `Initial` migration instead of creating a new one (e.g. during the development phase when the production database is not yet set up). In that case it convenient to reset the database schema and start afresh:

```bash
rm db/migrations/LastUnappliedMigration.ts
npm run db:reset
npm run db:create-migration
npm run db:migrate
```

To generate new type definitions for chain events and extrinsics:

```bash
# Review typegen section of manifest.yml (https://docs.subsquid.io/hydra-typegen)

# Delete old definitions
rm -rf chain

# Run typegen tool
npm run typegen
```

## Self-hosted indexer

It is recommended to use a readily set up indexer if available. It takes some time for a freshly started indexer
to get in sync with chain and catch the events.

Have a look at `./indexer/docker-compose.yml` for an example of how you can set up a self-hosted version.

## Misc

For more details, please checkout https://docs.subsquid.io.

## Developer Notes

Currently as of 2021/11/6 the public Polkadot idexer has been somewhat spotty in fetching block data
and queuing those blocks to be processed by the processor. This has lead to the Kusama chain being
processed and the Polkadot chain waiting for blocks.